/**
 * Code block enhancement tool
 * Add Mac window style toolbar to code blocks rendered by Shiki
 */

/**
 * Escape HTML special characters (for language name display)
 */
function escapeHtml(text: string): string {
  return text.replace(/[&<>"']/g, '');
}

export interface CodeBlockInfo {
  element: HTMLElement;
  language: string;
  code: string;
  codeHTML: string;
  preClassName: string;
  preStyle: string;
  codeClassName: string;
}

/**
 * Extract language from code blocks generated by Shiki
 */
export function extractLanguage(preElement: HTMLElement): string {
  // Check for mermaid class (astro-mermaid uses this)
  // Mermaid blocks are handled separately by mermaid-enhancer.ts
  if (preElement.classList.contains('mermaid')) {
    return 'mermaid';
  }

  // Primary method: Check for data-language attribute on pre element
  // This is the standard way Shiki adds language information in Astro
  // Shiki adds language information in the data-language attribute of the pre tag
  const dataLang = preElement.getAttribute('data-language');
  if (dataLang) {
    return dataLang;
  }

  // Fallback 1: Check for language-* class on code element
  // This handles cases where other markdown processors are used
  const codeElement = preElement.querySelector('code');
  if (codeElement) {
    const classes = codeElement.className.split(' ');
    const langClass = classes.find((cls) => cls.startsWith('language-'));
    if (langClass) {
      return langClass.replace('language-', '');
    }
  }

  // Fallback 2: Default to 'text' for plain code blocks
  return 'text';
}

/**
 * Extract code content (plain text)
 */
export function extractCode(preElement: HTMLElement): string {
  const codeElement = preElement.querySelector('code');
  return codeElement?.textContent || '';
}

/**
 * Extract code HTML (preserve syntax highlighting)
 */
export function extractCodeHTML(preElement: HTMLElement): string {
  const codeElement = preElement.querySelector('code');
  return codeElement?.innerHTML || '';
}

/**
 * Extract class of pre tag
 */
export function extractPreClassName(preElement: HTMLElement): string {
  return preElement.className;
}

/**
 * Extract inline style of pre tag
 */
export function extractPreStyle(preElement: HTMLElement): string {
  return preElement.getAttribute('style') || '';
}

/**
 * Extract class of code tag
 */
export function extractCodeClassName(preElement: HTMLElement): string {
  const codeElement = preElement.querySelector('code');
  return codeElement?.className || '';
}

export interface ToolbarOptions {
  enableCopy?: boolean;
  enableFullscreen?: boolean;
}

/**
 * Create toolbar HTML
 */
export function createToolbar(language: string, options: ToolbarOptions = {}): string {
  const { enableCopy = true, enableFullscreen = true } = options;
  // Escape language name to prevent XSS
  const safeLanguage = escapeHtml(language);

  const fullscreenBtn = enableFullscreen
    ? `
        <button
          class="code-block-button code-block-fullscreen"
          aria-label="Fullscreen view"
          title="Fullscreen view"
        >
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
          </svg>
        </button>`
    : '';

  const copyBtn = enableCopy
    ? `
        <button
          class="code-block-button code-block-copy"
          aria-label="Copy code"
          title="Copy code"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 448 512" fill="currentColor">
            <path d="M192 0c-35.3 0-64 28.7-64 64l0 256c0 35.3 28.7 64 64 64l192 0c35.3 0 64-28.7 64-64l0-200.6c0-17.4-7.1-34.1-19.7-46.2L370.6 17.8C358.7 6.4 342.8 0 326.3 0L192 0zM64 128c-35.3 0-64 28.7-64 64L0 448c0 35.3 28.7 64 64 64l192 0c35.3 0 64-28.7 64-64l0-16-64 0 0 16-192 0 0-256 16 0 0-64-16 0z"/>
          </svg>
        </button>`
    : '';

  return `
    <div class="code-block-toolbar">
      <div class="code-block-dots">
        <span class="code-block-dot red"></span>
        <span class="code-block-dot yellow"></span>
        <span class="code-block-dot green"></span>
        <span class="code-block-language">${safeLanguage}</span>
      </div>
      <div class="code-block-actions">
        ${fullscreenBtn}
        ${copyBtn}
      </div>
    </div>
  `;
}

/**
 * Copy to clipboard
 */
export async function copyToClipboard(text: string): Promise<boolean> {
  try {
    await navigator.clipboard.writeText(text);
    return true;
  } catch (err) {
    // Fallback for older browsers
    try {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      textArea.style.top = '-999999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      const success = document.execCommand('copy');
      document.body.removeChild(textArea);
      return success;
    } catch {
      console.error('Failed to copy:', err);
      return false;
    }
  }
}

/**
 * Enhance single code block
 */
export function enhanceCodeBlock(preElement: HTMLElement, options: ToolbarOptions = {}): CodeBlockInfo | null {
  // Avoid duplicate enhancement
  if (preElement.dataset.enhanced === 'true') {
    return null;
  }

  const language = extractLanguage(preElement);

  // Skip mermaid diagrams (handled by astro-mermaid)
  if (language === 'mermaid') {
    return null;
  }

  // Skip infographic diagrams (handled by infographic-enhancer)
  // Detection method: content starts with "infographic "
  const code = extractCode(preElement);
  if (code.trim().startsWith('infographic ')) {
    return null;
  }
  const codeHTML = extractCodeHTML(preElement);
  const preClassName = extractPreClassName(preElement);
  const preStyle = extractPreStyle(preElement);
  const codeClassName = extractCodeClassName(preElement);

  // Create wrapper container
  const wrapper = document.createElement('div');
  wrapper.className = 'code-block-wrapper';

  // Wrap pre into wrapper
  preElement.parentNode?.insertBefore(wrapper, preElement);
  wrapper.appendChild(preElement);

  // Insert toolbar before pre (as sibling node)
  preElement.insertAdjacentHTML('beforebegin', createToolbar(language, options));

  // Mark as enhanced
  preElement.dataset.enhanced = 'true';
  preElement.dataset.language = language;

  return {
    element: preElement,
    language,
    code,
    codeHTML,
    preClassName,
    preStyle,
    codeClassName,
  };
}

export interface EnhanceOptions {
  onCopy?: (code: string) => void;
  onFullscreen?: (info: CodeBlockInfo) => void;
  enableCopy?: boolean;
  enableFullscreen?: boolean;
}

/**
 * Enhance all code blocks
 */
export function enhanceAllCodeBlocks(container: Element, options: EnhanceOptions = {}): void {
  const { enableCopy = true, enableFullscreen = true } = options;
  const codeBlocks = container.querySelectorAll('pre');

  codeBlocks.forEach((pre) => {
    const preElement = pre as HTMLElement;
    const info = enhanceCodeBlock(preElement, { enableCopy, enableFullscreen });

    if (!info) return;

    // Bind copy button (button is in wrapper, not inside pre)
    if (enableCopy) {
      const copyBtn = preElement.parentElement?.querySelector('.code-block-copy');
      if (copyBtn) {
        // Save original SVG
        const originalSvg = copyBtn.innerHTML;
        // Checkmark SVG (copy success state)
        const checkmarkSvg = `
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
            <mask id="checkmark-anim-${Date.now()}">
              <g fill="none" stroke="#fff" stroke-dasharray="24" stroke-dashoffset="24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
                <path d="M2 13.5l4 4l10.75 -10.75">
                  <animate fill="freeze" attributeName="stroke-dashoffset" dur="0.4s" values="24;0"/>
                </path>
                <path stroke="#000" stroke-width="6" d="M7.5 13.5l4 4l10.75 -10.75">
                  <animate fill="freeze" attributeName="stroke-dashoffset" begin="0.4s" dur="0.4s" values="24;0"/>
                </path>
                <path d="M7.5 13.5l4 4l10.75 -10.75">
                  <animate fill="freeze" attributeName="stroke-dashoffset" begin="0.4s" dur="0.4s" values="24;0"/>
                </path>
              </g>
            </mask>
            <rect width="24" height="24" fill="currentColor" mask="url(#checkmark-anim-${Date.now()})"/>
          </svg>`;

        copyBtn.addEventListener('click', async () => {
          const success = await copyToClipboard(info.code);
          if (success) {
            copyBtn.classList.add('copied');
            copyBtn.innerHTML = checkmarkSvg;
            options.onCopy?.(info.code);
            setTimeout(() => {
              copyBtn.classList.remove('copied');
              copyBtn.innerHTML = originalSvg;
            }, 2000);
          }
        });
      }
    }

    // Bind fullscreen button (button is in wrapper, not inside pre)
    if (enableFullscreen) {
      const fullscreenBtn = preElement.parentElement?.querySelector('.code-block-fullscreen');
      if (fullscreenBtn) {
        fullscreenBtn.addEventListener('click', () => {
          options.onFullscreen?.(info);
        });
      }
    }
  });
}

/**
 * Create code view icon SVG (< > brackets with slash)
 */
export function createCodeViewIcon(): string {
  return `
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
      <path d="m7 8l-4 4l4 4m10-8l4 4l-4 4M14 4l-4 16"/>
    </svg>
  `;
}

/**
 * Create diagram view icon (bar chart icon)
 */
export function createDiagramViewIcon(): string {
  return `
    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
      <path d="M12 6a1 1 0 0 0-1 1v10a1 1 0 0 0 2 0V7a1 1 0 0 0-1-1m-5 6a1 1 0 0 0-1 1v4a1 1 0 0 0 2 0v-4a1 1 0 0 0-1-1m10-2a1 1 0 0 0-1 1v6a1 1 0 0 0 2 0v-6a1 1 0 0 0-1-1m2-8H5a3 3 0 0 0-3 3v14a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3V5a3 3 0 0 0-3-3m1 17a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1Z"/>
    </svg>
  `;
}
