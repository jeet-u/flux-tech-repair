---
/**
 * Christmas lights decoration component
 * Decorative lights hanging under the header, moving with the header
 *
 * Performance optimizations:
 * - Use opacity animation instead of box-shadow animation (avoid paint operations)
 * - Static box-shadow keeps glow effect
 * - Pause animation when tab is hidden
 * - Pause animation when Christmas is disabled
 */

// Bulb count: cover max screen width (spacing ~52px; 50 covers 2600px+)
const lightCount = 50;
---

<ul class="lightrope" aria-hidden="true">
  {Array.from({ length: lightCount }).map(() => <li />)}
</ul>

<script>
  function initLightsVisibility() {
    // Tab visibility detection - pause animation when hidden to save resources
    const handleVisibility = () => {
      document.documentElement.classList.toggle('lights-paused', document.hidden);
    };

    // Check state on init
    handleVisibility();

    document.addEventListener('visibilitychange', handleVisibility);
  }

  // Initialize
  if (document.readyState !== 'loading') {
    initLightsVisibility();
  }
  document.addEventListener('astro:page-load', initLightsVisibility);
</script>

<style>
  .lightrope {
    --globe-width: 12px;
    --globe-height: 28px;
    --globe-spacing: 40px;
    --globe-spread: 6px;
    --light-dim-opacity: 0.4;

    /* More vivid Christmas palette */
    --light-red: 255, 40, 40;
    --light-green: 50, 205, 50;
    --light-gold: 255, 200, 50;
    --light-blue: 100, 180, 255;

    position: absolute;
    top: calc(100% - 20px);
    left: 0;
    width: 100%;
    margin: 0;
    padding: 0;
    text-align: center;
    white-space: nowrap;
    overflow-x: clip;
    overflow-y: visible;
    pointer-events: none;
  }

  .lightrope li {
    position: relative;
    display: inline-block;
    width: var(--globe-width);
    height: var(--globe-height);
    margin: calc(var(--globe-spacing) / 2);
    padding: 0;
    list-style: none;
    border-radius: 50%;
    /* Vivid background and strong glow */
    background: rgb(var(--light-red));
    box-shadow:
      0px 4px 24px var(--globe-spread) rgba(var(--light-red), 1),
      0px 2px 8px 2px rgba(var(--light-red), 0.6);
    /* Opacity + scale animation - GPU composited */
    animation: flash-bulb 1.2s ease-in-out infinite;
  }

  /* Green bulbs */
  .lightrope li:nth-child(2n + 1) {
    background: rgb(var(--light-green));
    box-shadow:
      0px 4px 24px var(--globe-spread) rgba(var(--light-green), 1),
      0px 2px 8px 2px rgba(var(--light-green), 0.6);
  }

  /* Gold bulbs */
  .lightrope li:nth-child(4n + 2) {
    background: rgb(var(--light-gold));
    box-shadow:
      0px 4px 28px var(--globe-spread) rgba(var(--light-gold), 1),
      0px 2px 10px 2px rgba(var(--light-gold), 0.7);
  }

  /* Blue bulbs - add color variety */
  .lightrope li:nth-child(6n + 4) {
    background: rgb(var(--light-blue));
    box-shadow:
      0px 4px 24px var(--globe-spread) rgba(var(--light-blue), 1),
      0px 2px 8px 2px rgba(var(--light-blue), 0.6);
  }

  /* Animation delays - create chasing light effect */
  .lightrope li:nth-child(1) {
    animation-delay: 0s;
  }
  .lightrope li:nth-child(2) {
    animation-delay: 0.1s;
  }
  .lightrope li:nth-child(3) {
    animation-delay: 0.2s;
  }
  .lightrope li:nth-child(4) {
    animation-delay: 0.3s;
  }
  .lightrope li:nth-child(5) {
    animation-delay: 0.4s;
  }
  .lightrope li:nth-child(6) {
    animation-delay: 0.5s;
  }
  .lightrope li:nth-child(6n + 1) {
    animation-delay: 0s;
  }
  .lightrope li:nth-child(6n + 2) {
    animation-delay: 0.15s;
  }
  .lightrope li:nth-child(6n + 3) {
    animation-delay: 0.3s;
  }
  .lightrope li:nth-child(6n + 4) {
    animation-delay: 0.45s;
  }
  .lightrope li:nth-child(6n + 5) {
    animation-delay: 0.6s;
  }
  .lightrope li:nth-child(6n) {
    animation-delay: 0.75s;
  }

  /* Duration variation - add randomness */
  .lightrope li:nth-child(odd) {
    animation-duration: 1.4s;
  }

  .lightrope li:nth-child(3n) {
    animation-duration: 1s;
  }

  /* Socket */
  .lightrope li::before {
    content: '';
    position: absolute;
    top: calc(0px - var(--globe-height) / 6);
    left: 1px;
    width: calc(var(--globe-width) - 2px);
    height: calc(var(--globe-height) / 3);
    background: hsl(var(--background) / 0.6);
    border-radius: 3px;
  }

  /* Connecting wire */
  .lightrope li::after {
    content: '';
    position: absolute;
    top: calc(0px - var(--globe-height) / 2);
    left: calc(var(--globe-width) - 3px);
    width: calc(var(--globe-spacing) + 12px);
    height: calc(var(--globe-height) / 3 * 2);
    border-bottom: solid hsl(var(--background) / 0.6) 2px;
    border-radius: 50%;
  }

  /* Last bulb doesn't need a wire */
  .lightrope li:last-child::after {
    content: none;
  }

  /* Move first bulb left to hide edge */
  .lightrope li:first-child {
    margin-left: calc(0px - var(--globe-spacing));
  }

  /* Opacity + scale animation - GPU composited, no paint cost */
  @keyframes flash-bulb {
    0%,
    100% {
      opacity: 1;
      transform: scale(1);
    }
    50% {
      opacity: var(--light-dim-opacity);
      transform: scale(0.9);
    }
  }

  /* Pause animation when tab is hidden */
  :global(html.lights-paused) .lightrope li {
    animation-play-state: paused;
  }

  /* Pause animation when Christmas is disabled */
  :global(html:not(.christmas)) .lightrope li {
    animation-play-state: paused;
  }

  /* Accessibility: reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .lightrope li {
      animation: none;
    }
  }

  /* Show/hide based on Christmas state */
  :global(html:not(.christmas)) .lightrope {
    opacity: 0;
    transform: translateY(-40px);
    pointer-events: none;
  }

  .lightrope {
    transition:
      opacity 0.3s ease-out,
      transform 0.3s ease-out;
  }

  @media (prefers-reduced-motion: reduce) {
    .lightrope {
      transition: none;
    }
  }
</style>
