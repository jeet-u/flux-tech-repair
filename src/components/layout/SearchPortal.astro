---
/**
 * SearchPortal Component
 *
 * Provides the Pagefind search UI that gets portal'd into SearchDialog.
 * Listens for search-dialog-open/close events to move the search component.
 */
import Search from 'astro-pagefind/components/Search';
---

<!-- Search Component - will be portal'd into dialog -->
<div id="search-component-portal">
  <Search
    id="search-for-dialog"
    className="pagefind-ui"
    uiOptions={{
      showImages: false,
      resetStyles: false,
      translations: {
        placeholder: 'Enter a keyword to search',
        clear_search: 'Clear',
        load_more: 'Load more results',
        search_label: 'Search this site',
        filters_label: 'Filters',
        zero_results: 'No results found',
        many_results: '[COUNT] results',
        one_result: '[COUNT] result',
        alt_search: 'No results found. Showing results for [DIFFERENT_TERM]',
        search_suggestion: 'No results found. Try searching for:',
        searching: 'Searching [SEARCH_TERM]...',
      },
    }}
  />
</div>

<script>
  function moveSearchToDialog() {
    const dialogContainer = document.getElementById('search-dialog-container');
    const searchPortal = document.getElementById('search-component-portal');
    const searchComponent = document.getElementById('search-for-dialog');

    if (!dialogContainer || !searchPortal || !searchComponent) return;

    // Check if search component is already in the dialog
    if (dialogContainer.contains(searchComponent)) return;

    // Move search component to dialog
    dialogContainer.appendChild(searchComponent);
  }

  function moveSearchBack() {
    const searchComponent = document.getElementById('search-for-dialog');
    const searchPortal = document.getElementById('search-component-portal');

    if (!searchComponent || !searchPortal) return;

    // Move search component back to portal if it's not already there
    if (!searchPortal.contains(searchComponent)) {
      searchPortal.appendChild(searchComponent);
    }
  }

  function handleDialogOpen() {
    // Small delay to ensure dialog container is rendered
    requestAnimationFrame(() => {
      moveSearchToDialog();
    });
  }

  function handleDialogClose() {
    // Move search back immediately before DOM is removed
    moveSearchBack();
  }

  let initialized = false;

  function initSearchPortal() {
    if (initialized) return;
    initialized = true;

    window.addEventListener('search-dialog-open', handleDialogOpen);
    window.addEventListener('search-dialog-close', handleDialogClose);
  }

  function cleanupSearchPortal() {
    if (!initialized) return;

    window.removeEventListener('search-dialog-open', handleDialogOpen);
    window.removeEventListener('search-dialog-close', handleDialogClose);
    initialized = false;
  }

  // Initialize immediately if DOM is ready
  if (document.readyState !== 'loading') {
    initSearchPortal();
  }

  document.addEventListener('astro:page-load', initSearchPortal);
  document.addEventListener('astro:before-swap', cleanupSearchPortal);
</script>

<style>
  /* Hide the portal container */
  #search-component-portal {
    display: none;
    position: absolute;
    pointer-events: none;
    visibility: hidden;
  }
</style>
<style is:global>
  /* Ensure search is visible when in dialog */
  #search-dialog-container #search-for-dialog {
    display: block !important;
    visibility: visible !important;
    pointer-events: auto !important;
  }
</style>
